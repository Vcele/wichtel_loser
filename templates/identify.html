{% extends "base.html" %}

{% block title %}Find Yourself - Wichtel Loser{% endblock %}

{% block content %}
<div class="card">
    <h2>üîç Find Your Name</h2>
    <p style="margin-bottom: 1rem;">
        Event: <strong>{{ event.name }}</strong>
    </p>
    <p style="margin-bottom: 1rem; color: rgba(255,255,255,0.7);">
        We don't recognize you. Please search for your name to see your assignment:
    </p>
    
    <div class="search-container">
        <input type="text" id="search-input" placeholder="Start typing your name..." oninput="searchParticipants(this.value)" autofocus>
        <div class="search-results" id="search-results"></div>
    </div>
    
    <form id="identity-form" method="POST" action="/event/{{ event.id }}/confirm-identity" style="display: none;">
        <input type="hidden" name="participant_id" id="selected-participant-id">
    </form>
</div>

<div class="card">
    <h2>üë• All Participants</h2>
    <p style="margin-bottom: 1rem; color: rgba(255,255,255,0.7);">
        Click on your name below:
    </p>
    <ul class="participant-list">
        {% for id, participant in event.participants %}
        <li class="participant-item" style="cursor: pointer;" onclick="selectParticipant('{{ participant.id }}', '{{ participant.name }}')">
            <div class="participant-avatar">üéÖ</div>
            <span>{{ participant.name }}</span>
        </li>
        {% endfor %}
    </ul>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let searchTimeout;
    
    function searchParticipants(query) {
        clearTimeout(searchTimeout);
        const resultsContainer = document.getElementById('search-results');
        
        if (query.length < 1) {
            resultsContainer.classList.remove('active');
            return;
        }
        
        searchTimeout = setTimeout(async () => {
            try {
                const response = await fetch(`/event/{{ event.id }}/search?q=${encodeURIComponent(query)}`);
                const results = await response.json();
                
                if (results.length > 0) {
                    resultsContainer.innerHTML = results.map(r => `
                        <div class="search-result-item" onclick="selectParticipant('${r.id}', '${r.name}')">
                            <strong>${r.name}</strong>
                        </div>
                    `).join('');
                    resultsContainer.classList.add('active');
                } else {
                    resultsContainer.innerHTML = '<div class="search-result-item">No matches found</div>';
                    resultsContainer.classList.add('active');
                }
            } catch (err) {
                console.error('Search error:', err);
            }
        }, 300);
    }
    
    function selectParticipant(id, name) {
        if (confirm(`Are you ${name}?`)) {
            document.getElementById('selected-participant-id').value = id;
            document.getElementById('identity-form').submit();
        }
    }
</script>
{% endblock %}
